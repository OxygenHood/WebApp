{% extends "base.html" %}

{% block title %}模型训练 - 无人机集群动态任务分配仿真平台{% endblock %}

{% block page_title %}模型训练{% endblock %}

{% block content %}
<div class="page-container">
    <div class="content-card">
        <div class="header-row">
            <div>
                <h2>模型训练</h2>
                <p class="subtitle">选择场景与任务类型，填写超参数后点击开始训练。</p>
            </div>
        </div>

        <!-- 提示消息 -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form method="POST" action="{{ url_for('train_model') }}" class="train-form">
            <div class="form-grid">
                <div class="form-group">
                    <label for="scenario">选择场景 <span class="required">*</span></label>
                    <select id="scenario" name="scenario_id" required {% if not scenarios %}disabled{% endif %}>
                        <option value="">请选择</option>
                        {% for scenario in scenarios %}
                            <option value="{{ scenario.id }}">{{ scenario.name }}</option>
                        {% endfor %}
                    </select>
                    {% if not scenarios %}
                        <small class="hint">暂无可用场景，请先创建场景后再试。</small>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="train_type">任务类型 <span class="required">*</span></label>
                    <select id="train_type" name="train_type" required>
                        <option value="">请选择</option>
                        <option value="target_allocation">目标分配</option>
                        <option value="fire_allocaltion">火力分配</option>
                    </select>
                </div>
            </div>

            <div class="param-section">
                <div class="param-header">
                    <h4>训练超参数</h4>
                    <span class="muted">参数参考模型配置，随任务类型自动填充</span>
                </div>

                <div class="param-subtitle">算法参数</div>
                <div class="param-grid">
                    <div class="form-group">
                        <label for="clip_param">剪切范围 (clip_param)</label>
                        <input type="number" step="0.01" id="clip_param" name="clip_param" placeholder="0.2">
                    </div>
                    <div class="form-group">
                        <label for="entropy_coef">熵系数</label>
                        <input type="number" step="0.001" id="entropy_coef" name="entropy_coef" placeholder="0.01">
                    </div>
                    <div class="form-group">
                        <label for="gamma">折扣因子 (gamma)</label>
                        <input type="number" step="0.01" id="gamma" name="gamma" placeholder="0.99" min="0" max="1">
                    </div>
                    <div class="form-group">
                        <label for="gae_lambda">GAE λ</label>
                        <input type="number" step="0.01" id="gae_lambda" name="gae_lambda" placeholder="0.95" min="0" max="1">
                    </div>
                    <div class="form-group">
                        <label for="ppo_epoch">PPO 轮次</label>
                        <input type="number" id="ppo_epoch" name="ppo_epoch" placeholder="5" min="1">
                    </div>
                    <div class="form-group">
                        <label for="actor_num_mini_batch">Actor mini-batch</label>
                        <input type="number" id="actor_num_mini_batch" name="actor_num_mini_batch" placeholder="1" min="1">
                    </div>
                    <div class="form-group">
                        <label for="value_loss_coef">价值函数系数</label>
                        <input type="number" step="0.1" id="value_loss_coef" name="value_loss_coef" placeholder="1">
                    </div>
                    <div class="form-group">
                        <label for="max_grad_norm">最大梯度范数</label>
                        <input type="number" step="0.1" id="max_grad_norm" name="max_grad_norm" placeholder="10">
                    </div>
                    <div class="form-group">
                        <label for="use_gae">启用 GAE</label>
                        <select id="use_gae" name="use_gae">
                            <option value="">请选择</option>
                            <option value="true">true</option>
                            <option value="false">false</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="use_clipped_value_loss">剪切价值函数</label>
                        <select id="use_clipped_value_loss" name="use_clipped_value_loss">
                            <option value="">请选择</option>
                            <option value="true">true</option>
                            <option value="false">false</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="use_policy_active_masks">使用 active masks</label>
                        <select id="use_policy_active_masks" name="use_policy_active_masks">
                            <option value="">请选择</option>
                            <option value="true">true</option>
                            <option value="false">false</option>
                        </select>
                    </div>
                </div>

                <div class="param-subtitle">模型参数</div>
                <div class="param-grid">
                    <div class="form-group">
                        <label for="lr">学习率 (lr)</label>
                        <input type="number" step="0.000001" id="lr" name="lr" placeholder="0.0005" min="0">
                    </div>
                    <div class="form-group">
                        <label for="critic_lr">Critic 学习率</label>
                        <input type="number" step="0.000001" id="critic_lr" name="critic_lr" placeholder="0.0005" min="0">
                    </div>
                    <div class="form-group">
                        <label for="hidden_sizes">隐藏层宽度</label>
                        <input type="text" id="hidden_sizes" name="hidden_sizes" placeholder="128,128">
                    </div>
                    <div class="form-group">
                        <label for="activation_func">激活函数</label>
                        <input type="text" id="activation_func" name="activation_func" placeholder="relu">
                    </div>
                    <div class="form-group">
                        <label for="initialization_method">初始化方法</label>
                        <input type="text" id="initialization_method" name="initialization_method" placeholder="orthogonal_">
                    </div>
                    <div class="form-group">
                        <label for="std_x_coef">std_x_coef</label>
                        <input type="number" step="0.1" id="std_x_coef" name="std_x_coef" placeholder="1">
                    </div>
                    <div class="form-group">
                        <label for="std_y_coef">std_y_coef</label>
                        <input type="number" step="0.1" id="std_y_coef" name="std_y_coef" placeholder="0.5">
                    </div>
                    <div class="form-group">
                        <label for="use_feature_normalization">特征归一化</label>
                        <select id="use_feature_normalization" name="use_feature_normalization">
                            <option value="">请选择</option>
                            <option value="true">true</option>
                            <option value="false">false</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="use_recurrent_policy">循环策略</label>
                        <select id="use_recurrent_policy" name="use_recurrent_policy">
                            <option value="">请选择</option>
                            <option value="true">true</option>
                            <option value="false">false</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="weight_decay">权重衰减</label>
                        <input type="number" step="0.0001" id="weight_decay" name="weight_decay" placeholder="0">
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary" {% if not scenarios %}disabled{% endif %}>
                    <i class="fas fa-rocket"></i> 开始训练
                </button>
                <a href="{{ url_for('model') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> 返回模型管理
                </a>
            </div>
        </form>
    </div>
</div>

<script>
const trainPresets = {{ train_presets | tojson }};

function setInputValue(id, value) {
    const el = document.getElementById(id);
    if (!el || value === undefined || value === null) return;
    if (el.tagName === 'SELECT') {
        el.value = String(value);
    } else if (Array.isArray(value)) {
        el.value = value.join(',');
    } else {
        el.value = value;
    }
}

function applyPreset(type) {
    const preset = trainPresets[type];
    if (!preset) return;
    const algo = preset.algo || {};
    const model = preset.model || {};
    Object.entries({
        clip_param: algo.clip_param,
        entropy_coef: algo.entropy_coef,
        gamma: algo.gamma,
        gae_lambda: algo.gae_lambda,
        ppo_epoch: algo.ppo_epoch,
        actor_num_mini_batch: algo.actor_num_mini_batch,
        value_loss_coef: algo.value_loss_coef,
        max_grad_norm: algo.max_grad_norm,
        use_gae: algo.use_gae,
        use_clipped_value_loss: algo.use_clipped_value_loss,
        use_policy_active_masks: algo.use_policy_active_masks,
        lr: model.lr,
        critic_lr: model.critic_lr,
        hidden_sizes: model.hidden_sizes,
        activation_func: model.activation_func,
        initialization_method: model.initialization_method,
        std_x_coef: model.std_x_coef,
        std_y_coef: model.std_y_coef,
        use_feature_normalization: model.use_feature_normalization,
        use_recurrent_policy: model.use_recurrent_policy,
        weight_decay: model.weight_decay
    }).forEach(([key, val]) => setInputValue(key, val));
}

document.addEventListener('DOMContentLoaded', () => {
    const trainType = document.getElementById('train_type');
    if (trainType) {
        trainType.addEventListener('change', (e) => applyPreset(e.target.value));
    }
    // 初始根据当前选择应用一次
    if (trainType && trainType.value) {
        applyPreset(trainType.value);
    }
});
</script>

<style>
.header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
}
.subtitle {
    margin: 0.25rem 0 0;
    color: #6b7280;
}
.alert {
    padding: 0.75rem 1rem;
    margin: 1rem 0;
    border-radius: 6px;
}
.alert-success { background: #ecfdf3; color: #166534; border: 1px solid #bbf7d0; }
.alert-error { background: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; }
.train-form {
    margin-top: 1rem;
}
.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 1rem;
}
.form-group {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
}
.form-group label {
    font-weight: 700;
    color: #111827;
}
.form-group input,
.form-group select {
    padding: 0.65rem 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.95rem;
}
.required {
    color: #ef4444;
}
.hint {
    color: #9ca3af;
    font-size: 0.9rem;
}
.param-section {
    margin-top: 1.5rem;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 1rem;
    background: #f9fafb;
}
.param-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 0.75rem;
}
.param-subtitle {
    margin: 0.75rem 0 0.35rem;
    font-weight: 700;
    color: #111827;
}
.param-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 0.75rem;
}
.muted {
    color: #6b7280;
    font-size: 0.9rem;
}
.form-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: 1.5rem;
}
.btn {
    padding: 0.7rem 1.4rem;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    transition: all 0.2s;
}
.btn-primary {
    background: #2563eb;
    color: #fff;
}
.btn-primary:hover { background: #1d4ed8; }
.btn-secondary {
    background: #e5e7eb;
    color: #111827;
}
.btn-secondary:hover { background: #d4d8dd; }
@media (max-width: 768px) {
    .header-row {
        flex-direction: column;
        align-items: flex-start;
    }
    .form-actions {
        flex-direction: column;
    }
    .btn {
        width: 100%;
        justify-content: center;
    }
}
</style>
{% endblock %}
