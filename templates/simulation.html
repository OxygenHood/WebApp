{% extends "base.html" %}

{% block title %}ä»¿çœŸè¯„ä¼° - æ— äººé›†ç¾¤æŒ‡æ§ç³»ç»Ÿ{% endblock %}

{% block page_title %}ä»¿çœŸè¯„ä¼°{% endblock %}

{% block content %}
<!-- Leaflet.js CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin="" />

<div class="simulation-container">
    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="control-panel">
        <div class="panel-header">
            <h3><i class="fas fa-cogs"></i> ä»¿çœŸæ§åˆ¶</h3>
        </div>
        <div class="panel-content">
            <div class="control-group">
                <label>ä»¿çœŸçŠ¶æ€ï¼š</label>
                <span class="status-badge" id="simStatus">å°±ç»ª</span>
            </div>
            <div class="control-group">
                <label>æ— äººæœºæ•°é‡ï¼š</label>
                <span id="droneCount">0</span>
            </div>
            <div class="control-group">
                <label>ä½œæˆ˜åŒºåŸŸï¼š</label>
                <span>å°æ¹¾æµ·å³¡</span>
            </div>
            <div class="control-group">
                <label>å¤©æ°”çŠ¶å†µï¼š</label>
                <span style="color: #28a745;">è‰¯å¥½</span>
            </div>
            <div class="control-group">
                <label>æµ·å†µç­‰çº§ï¼š</label>
                <span style="color: #007bff;">3çº§</span>
            </div>
            <div class="control-buttons">
                <button class="btn btn-primary" id="startSim">
                    <i class="fas fa-play"></i> å¼€å§‹ä»¿çœŸ
                </button>
                <button class="btn btn-warning" id="pauseSim">
                    <i class="fas fa-pause"></i> æš‚åœ
                </button>
                <button class="btn btn-danger" id="stopSim">
                    <i class="fas fa-stop"></i> åœæ­¢
                </button>
            </div>
            <div class="info-section">
                <h4>åœ°å›¾æ“ä½œè¯´æ˜ï¼š</h4>
                <ul>
                    <li>é¼ æ ‡æ‹–æ‹½ï¼šç§»åŠ¨åœ°å›¾</li>
                    <li>æ»šè½®ç¼©æ”¾ï¼šæ”¾å¤§/ç¼©å°åœ°å›¾</li>
                    <li>ç‚¹å‡»æ ‡è®°ï¼šæŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</li>
                    <li>å›¾å±‚åˆ‡æ¢ï¼šä½¿ç”¨å³ä¸Šè§’æ§åˆ¶å™¨</li>
                </ul>
            </div>
            <div class="info-section">
                <h4>å›¾ä¾‹è¯´æ˜ï¼š</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 0.8rem;">
                    <div>ğŸ­ å†›äº‹åŸºåœ°</div>
                    <div>âš“ æ¸¯å£è®¾æ–½</div>
                    <div>ğŸ“¡ é›·è¾¾ç«™ç‚¹</div>
                    <div>âš”ï¸ ä½œæˆ˜åŒºåŸŸ</div>
                    <div>ğŸŒŠ æµ·åŸŸ</div>
                    <div>âœˆï¸ æ— äººæœº</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- åœ°å›¾åŒºåŸŸ -->
    <div class="map-container">
        <div id="simulationMap" class="simulation-map"></div>
        
        <!-- åœ°å›¾ä¿¡æ¯æ˜¾ç¤º -->
        <div class="map-info" id="mapInfo">
            <div class="coords-info">
                <span>ç»åº¦ï¼š</span><span id="longitude">--</span>
                <span>çº¬åº¦ï¼š</span><span id="latitude">--</span>
                <span>ç¼©æ”¾çº§åˆ«ï¼š</span><span id="zoomLevel">--</span>
            </div>
        </div>
    </div>
</div>

<!-- Leaflet.js JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<script>
// å…¨å±€å˜é‡
let map;
let droneMarkers = [];
let isSimulationRunning = false;

// åˆå§‹åŒ–åœ°å›¾
function initMap() {
    // åˆ›å»ºåœ°å›¾å®ä¾‹ï¼ˆä»¥å°æ¹¾æµ·å³¡ä¸ºä¸­å¿ƒï¼‰
    // å°æ¹¾æµ·å³¡ä¸­å¿ƒä½ç½®ï¼šåŒ—çº¬24.5Â°ï¼Œä¸œç»120.0Â°
    map = L.map('simulationMap').setView([24.5, 120.0], 8);
    
    // å®šä¹‰å¤šç§åœ°å›¾å›¾å±‚
    const baseMaps = {
        'æ ‡å‡†åœ°å›¾': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }),
        
        'å«æ˜Ÿå›¾': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
            maxZoom: 19
        }),
        
        'åœ°å½¢å›¾': L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)',
            maxZoom: 17
        })
    };
    
    // é»˜è®¤ä½¿ç”¨å«æ˜Ÿå›¾ï¼ˆæ›´é€‚åˆæµ·ä¸Šä½œæˆ˜ï¼‰
    baseMaps['å«æ˜Ÿå›¾'].addTo(map);
    
    // æ·»åŠ å›¾å±‚æ§åˆ¶å™¨
    L.control.layers(baseMaps).addTo(map);
    
    // æ·»åŠ æ¯”ä¾‹å°ºæ§ä»¶
    L.control.scale().addTo(map);
    
    // ç›‘å¬åœ°å›¾äº‹ä»¶
    map.on('mousemove', function(e) {
        updateMapInfo(e.latlng.lat, e.latlng.lng, map.getZoom());
    });
    
    map.on('zoomend', function() {
        const center = map.getCenter();
        updateMapInfo(center.lat, center.lng, map.getZoom());
    });
    
    // æ·»åŠ å°æ¹¾æµ·å³¡ç›¸å…³æ ‡è®°
    addMaritimeMarkers();
    
    console.log('å°æ¹¾æµ·å³¡åœ°å›¾åˆå§‹åŒ–å®Œæˆ');
}

// æ›´æ–°åœ°å›¾ä¿¡æ¯æ˜¾ç¤º
function updateMapInfo(lat, lng, zoom) {
    document.getElementById('latitude').textContent = lat.toFixed(6);
    document.getElementById('longitude').textContent = lng.toFixed(6);
    document.getElementById('zoomLevel').textContent = zoom;
}

// æ·»åŠ å°æ¹¾æµ·å³¡ç›¸å…³æ ‡è®°
function addMaritimeMarkers() {
    // æ·»åŠ å°æ¹¾æµ·å³¡é‡è¦åœ°ç†ä½ç½®å’Œå†›äº‹è¦ç‚¹
    const maritimePoints = [
        // é‡è¦æ¸¯å£å’ŒåŸºåœ°
        { lat: 25.0330, lng: 121.5654, name: 'å°åŒ—æ¸¯åŒº', type: 'port', description: 'é‡è¦æ¸¯å£è®¾æ–½' },
        { lat: 22.6273, lng: 120.3014, name: 'é«˜é›„æ¸¯åŒº', type: 'port', description: 'å—éƒ¨ä¸»è¦æ¸¯å£' },
        { lat: 24.1477, lng: 120.6736, name: 'å°ä¸­æ¸¯åŒº', type: 'port', description: 'ä¸­éƒ¨æ¸¯å£è®¾æ–½' },
        
        // æˆ˜ç•¥è¦ç‚¹
        { lat: 24.7736, lng: 120.9436, name: 'ä½œæˆ˜åŒºåŸŸA', type: 'combat_zone', description: 'åŒ—éƒ¨ä½œæˆ˜åŒºåŸŸ' },
        { lat: 23.8041, lng: 120.4218, name: 'ä½œæˆ˜åŒºåŸŸB', type: 'combat_zone', description: 'ä¸­éƒ¨ä½œæˆ˜åŒºåŸŸ' },
        { lat: 22.9908, lng: 120.2133, name: 'ä½œæˆ˜åŒºåŸŸC', type: 'combat_zone', description: 'å—éƒ¨ä½œæˆ˜åŒºåŸŸ' },
        
        // å…³é”®æµ·åŸŸ
        { lat: 25.2954, lng: 119.5269, name: 'åŒ—éƒ¨æµ·åŸŸ', type: 'sea_area', description: 'åŒ—éƒ¨è­¦æˆ’æµ·åŸŸ' },
        { lat: 24.0000, lng: 119.0000, name: 'ä¸­å¤®æµ·åŸŸ', type: 'sea_area', description: 'ä¸­å¤®ä½œæˆ˜æµ·åŸŸ' },
        { lat: 22.5000, lng: 118.5000, name: 'å—éƒ¨æµ·åŸŸ', type: 'sea_area', description: 'å—éƒ¨å·¡é€»æµ·åŸŸ' },
        
        // é›·è¾¾ç«™ç‚¹
        { lat: 25.1972, lng: 121.6419, name: 'é›·è¾¾ç«™Alpha', type: 'radar', description: 'åŒ—éƒ¨é¢„è­¦é›·è¾¾ç«™' },
        { lat: 23.5731, lng: 120.8395, name: 'é›·è¾¾ç«™Beta', type: 'radar', description: 'ä¸­éƒ¨ç›‘æ§é›·è¾¾ç«™' },
        { lat: 22.2370, lng: 120.8397, name: 'é›·è¾¾ç«™Gamma', type: 'radar', description: 'å—éƒ¨è·Ÿè¸ªé›·è¾¾ç«™' }
    ];
    
    maritimePoints.forEach(point => {
        const icon = getMarkerIcon(point.type);
        const marker = L.marker([point.lat, point.lng], { icon: icon })
            .addTo(map)
            .bindPopup(`
                <div style="min-width: 200px;">
                    <h4 style="margin: 0 0 8px 0; color: #2c3e50;">${point.name}</h4>
                    <p style="margin: 0 0 6px 0; color: #7f8c8d; font-size: 0.9rem;">
                        <strong>ç±»å‹ï¼š</strong>${getTypeDescription(point.type)}
                    </p>
                    <p style="margin: 0 0 6px 0; color: #7f8c8d; font-size: 0.9rem;">
                        <strong>æè¿°ï¼š</strong>${point.description}
                    </p>
                    <p style="margin: 0; color: #007bff; font-size: 0.8rem; font-family: monospace;">
                        <strong>åæ ‡ï¼š</strong>${point.lat.toFixed(4)}Â°N, ${point.lng.toFixed(4)}Â°E
                    </p>
                </div>
            `);
    });
    
    // æ·»åŠ å°æ¹¾æµ·å³¡ä¸­å¿ƒçº¿ï¼ˆå‚è€ƒçº¿ï¼‰
    const straitCenterLine = [
        [25.5, 119.8],
        [24.5, 120.0],
        [23.5, 120.2],
        [22.5, 120.4]
    ];
    
    L.polyline(straitCenterLine, {
        color: '#dc3545',
        weight: 2,
        opacity: 0.6,
        dashArray: '10, 10'
    }).addTo(map).bindPopup('å°æ¹¾æµ·å³¡ä¸­å¿ƒå‚è€ƒçº¿');
    
    // æ·»åŠ ä½œæˆ˜è¾¹ç•Œç¤ºä¾‹
    const combatBoundary = [
        [26.0, 119.0],
        [26.0, 122.0],
        [22.0, 122.0],
        [22.0, 119.0],
        [26.0, 119.0]
    ];
    
    L.polygon(combatBoundary, {
        color: '#007bff',
        weight: 2,
        opacity: 0.6,
        fillColor: '#007bff',
        fillOpacity: 0.1
    }).addTo(map).bindPopup('ä½œæˆ˜åŒºåŸŸè¾¹ç•Œ');
}

// è·å–ä¸åŒç±»å‹çš„æ ‡è®°å›¾æ ‡
function getMarkerIcon(type) {
    const icons = {
        // å†›äº‹è®¾æ–½
        base: 'ğŸ­',
        port: 'âš“',
        radar: 'ğŸ“¡',
        
        // ä½œæˆ˜è¦ç´ 
        combat_zone: 'âš”ï¸',
        sea_area: 'ğŸŒŠ',
        waypoint: 'ğŸ“',
        target: 'ğŸ¯',
        
        // å¹³å°
        drone: 'âœˆï¸',
        ship: 'ğŸš¢',
        submarine: 'ğŸ”±'
    };
    
    const colors = {
        base: '#28a745',
        port: '#17a2b8',
        radar: '#ffc107',
        combat_zone: '#dc3545',
        sea_area: '#007bff',
        waypoint: '#6c757d',
        target: '#fd7e14',
        drone: '#6f42c1',
        ship: '#20c997',
        submarine: '#e83e8c'
    };
    
    return L.divIcon({
        html: `<div style="
            font-size: 20px; 
            text-align: center; 
            line-height: 1;
            filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.3));
            background: ${colors[type] || '#6c757d'};
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        ">${icons[type] || 'ğŸ“'}</div>`,
        className: 'custom-marker',
        iconSize: [32, 32],
        iconAnchor: [16, 16]
    });
}

// è·å–ç±»å‹æè¿°
function getTypeDescription(type) {
    const descriptions = {
        base: 'å†›äº‹åŸºåœ°',
        port: 'æ¸¯å£è®¾æ–½',
        radar: 'é›·è¾¾ç«™ç‚¹',
        combat_zone: 'ä½œæˆ˜åŒºåŸŸ',
        sea_area: 'æµ·åŸŸ',
        waypoint: 'èˆªè·¯ç‚¹',
        target: 'ç›®æ ‡ç‚¹',
        drone: 'æ— äººæœº',
        ship: 'èˆ°èˆ¹',
        submarine: 'æ½œè‰‡'
    };
    return descriptions[type] || 'æœªçŸ¥ç±»å‹';
}

// ä»¿çœŸæ§åˆ¶åŠŸèƒ½
function startSimulation() {
    if (!isSimulationRunning) {
        isSimulationRunning = true;
        document.getElementById('simStatus').textContent = 'è¿è¡Œä¸­';
        document.getElementById('simStatus').className = 'status-badge running';
        console.log('ä»¿çœŸå¼€å§‹');
    }
}

function pauseSimulation() {
    if (isSimulationRunning) {
        isSimulationRunning = false;
        document.getElementById('simStatus').textContent = 'å·²æš‚åœ';
        document.getElementById('simStatus').className = 'status-badge paused';
        console.log('ä»¿çœŸæš‚åœ');
    }
}

function stopSimulation() {
    isSimulationRunning = false;
    document.getElementById('simStatus').textContent = 'å°±ç»ª';
    document.getElementById('simStatus').className = 'status-badge';
    console.log('ä»¿çœŸåœæ­¢');
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒ–åœ°å›¾
    initMap();
    
    // ç»‘å®šæŒ‰é’®äº‹ä»¶
    document.getElementById('startSim').addEventListener('click', startSimulation);
    document.getElementById('pauseSim').addEventListener('click', pauseSimulation);
    document.getElementById('stopSim').addEventListener('click', stopSimulation);
    
    console.log('ä»¿çœŸè¯„ä¼°é¡µé¢åˆå§‹åŒ–å®Œæˆ');
});
</script>

{% endblock %}