# 仿真系统设计文档

## 引言
- 目标：面向既有目标分配与火力分配算法的效果验证，构建可视化仿真系统，支撑算法在台海作战场景下的快速对比、调优与结果留痕。
- 范围：涵盖用户登录、作战场景配置、模型管理与选择、地图仿真演示及日志存证；不包含训练环节，模型由外部生成后接入。
- 受众：算法与系统研发人员、测试人员以及指挥决策支持相关的业务方。

## 仿真系统需求分析
- 功能需求
  - 认证与权限：登录后访问各模块（`/login`、`/logout`）；会话由 `app.secret_key` 管理。
  - 场景管理：创建/编辑/删除场景（台海作战），配置我方无人机位置/高度/载荷，配置敌方侦察无人机、武装直升机、坦克、装甲车、军事基地等单位及坐标。
  - 模型管理：扫描 `models/target_allocation` 与 `models/fire_allocaltion` 目录下的 `config.json` 与 `progress.txt`，入库去重，展示算法/环境/场景、步数、最佳指标，并可重命名。
  - 仿真评估：在 `/simulation` 选择场景与两类模型（缺一不可），在地图上加载单位标记并启动/暂停/停止动画式仿真。
  - 日志记录：前端操作与异常通过 `/api/save_log` 写入 `logs/simulation_YYYYMMDD.txt`。
  - 数据接口：`/api/scenarios`、`/api/scenario/<id>`、`/api/models` 等为前端下拉列表与地图加载提供数据。
- 数据与存储
  - 数据库：SQLite 文件 `webapp.db`。核心表
    - `users(username, password_hash)`：登录账户。
    - `scenarios(...)`：场景元数据、我方载荷 JSON、敌方单位数量与位置。
    - `models(...)`：从文件系统同步的模型信息，`config_path` 唯一索引。
  - 文件系统：`models/` 存放算法成果，`logs/` 落地仿真日志。
- 非功能需求
  - 可用性：地图交互（Leaflet）与下拉选择提供即时反馈；必选项有显式提示。
  - 扩展性：模型目录新增即自动同步；场景/单位类型可按同结构扩展。
  - 可运维性：日志按日分文件；数据库/文件路径规范化避免重复。

## 系统设计
- 总体架构
  - 前端：Flask + Jinja2 模板；Leaflet 地图渲染；原生 JS 控制仿真状态、模型/场景选择。
  - 后端：Flask 路由统一承载页面与 API；SQLite 持久化；文件系统同步模型元数据。
  - 主要模块
    - 认证模块：`/login`、`/logout`，`login_required` 装饰器保护内页。
    - 场景模块：`/pipeline` 展示；`/create_scenario`、`/edit_scenario/<id>`、`/delete_scenario/<id>` 完成 CRUD。
    - 模型模块：`/model`、`/model/<id>` 与 `/api/models`，负责目录扫描、进度解析、重命名。
    - 仿真模块：`/simulation` 页面 + `/api/scenario/<id>` 数据接口，实现地图加载、运动模拟、状态切换。
    - 日志模块：`/api/save_log` 统一落盘。
- 关键设计要点
  - 模型同步：`sync_models_from_fs()` 读取 `config.json`、`progress.txt`，解析 algo/env/scenario、训练步数与最佳指标，入库去重（路径归一 + UNIQUE 索引）。
  - 场景数据：前端以 JSON 维护无人机/敌方单位配置；后端将载荷、位置分列存储，兼容历史数据。
  - 仿真渲染：地图默认台湾海峡中心（24.5N,120E），多底图切换；单位以自定义图标标记，弹窗展示编号、坐标、载荷/高度。
  - 运动模拟：基于设定速度与随机目标点的间歇位移（默认 1s 步长），支持开始/暂停/停止，停止后自动恢复初始态。

## 仿真系统工作流程
1) 登录：用户在 `/login` 认证成功后进入首页，带会话状态访问各功能。
2) 场景配置：在 `/create_scenario` 或 `/edit_scenario/<id>` 录入我方无人机（经纬高、载荷雷达/HQ9B）与敌方单位（类型、数量、坐标、编号），保存入库。
3) 模型准备：将目标分配/火力分配模型成果置于对应目录，系统自动扫描入库，前端下拉实时可选。
4) 仿真设置：在 `/simulation` 选择场景并加载到地图；分别选择目标分配与火力分配模型，下方状态牌实时显示选择结果。
5) 仿真运行：点击“开始仿真”后，地图上单位按速度与随机航迹移动；可暂停/继续或停止（停止后重置至初始位置），全程事件写入日志。
6) 结果观测：通过地图标记、弹窗、状态牌与日志文本验证两类算法在当前场景下的协同表现，为后续算法调优与再训练提供依据。
